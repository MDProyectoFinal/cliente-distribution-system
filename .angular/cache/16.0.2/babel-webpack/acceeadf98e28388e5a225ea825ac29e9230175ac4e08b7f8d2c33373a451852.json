{"ast":null,"code":"import _asyncToGenerator from \"C:/wamp/www/rosario-snack/cliente/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { UsuarioServices } from \"../services/usuario.services\";\nimport { GLOBAL } from \"../services/global\";\nimport { Usuario } from \"../models/usuario\";\nimport { UsuarioPersona } from \"../models/usuarioPersona\";\nimport { Persona } from \"../models/persona\";\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../services/usuario.services\";\nimport * as i2 from \"../services/persona.services\";\nimport * as i3 from \"@angular/common\";\nimport * as i4 from \"@angular/forms\";\nfunction UsuarioEdicionComponent_div_4_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\")(1, \"div\", 21);\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r0.alertaActualizacion, \" \");\n  }\n}\nfunction UsuarioEdicionComponent_span_12_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtext(1, \" El nombre es obligatorio. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction UsuarioEdicionComponent_span_18_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtext(1, \" El apellido es obligatorio. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction UsuarioEdicionComponent_span_24_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtext(1, \" La direcci\\u00F3n es obligatoria. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction UsuarioEdicionComponent_span_30_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtext(1, \" El tel\\u00E9fono es obligatorio. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction UsuarioEdicionComponent_span_37_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtext(1, \" El nombre de usuario es obligatorio. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction UsuarioEdicionComponent_span_43_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtext(1, \" El correo electr\\u00F3nico es obligatorio. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction UsuarioEdicionComponent_span_49_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtext(1, \" El rol es obligatorio. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction UsuarioEdicionComponent_div_50_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 22);\n    i0.ɵɵelement(1, \"img\", 23);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r16 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(1);\n    i0.ɵɵpropertyInterpolate(\"src\", ctx_r16.url + \"obtener-archivo-imagen/\" + ctx_r16.usuario_persona_actualizacion.imagen, i0.ɵɵsanitizeUrl);\n  }\n}\nlet UsuarioEdicionComponent = /*#__PURE__*/(() => {\n  class UsuarioEdicionComponent {\n    constructor(_usuarioServicio, _personaServices) {\n      this._usuarioServicio = _usuarioServicio;\n      this._personaServices = _personaServices;\n      this.alertaActualizacion = \"\";\n      this.titulo = 'Actualizar mis datos';\n      // LocalStorage\n      this.identity = this._usuarioServicio.getIdentity(); // \"\"\n      this.token = this._usuarioServicio.getToken(); // \"\"\n      this.usuario = new Usuario('', '', '', '', '', 'ROLE_USER', '', new Date(), new Date(), false);\n      this.url = GLOBAL.url;\n      this.usuario_persona_actualizacion = JSON.parse(this.identity);\n      this.usuario_persona_guardada = null;\n      this.filesToUpload = null;\n    }\n    ngOnInit() {\n      console.log('usuario-edicion.component.ts cargado');\n      console.log(this.usuario_persona_actualizacion);\n    }\n    onSubmit() {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        console.log(_this.usuario_persona_actualizacion);\n        try {\n          // A la respuesta la declaramos del tipo interfaz para poder trabajar con el user y persona dentro\n          var response = yield _this._usuarioServicio.actualizarUsuario(_this.usuario_persona_actualizacion);\n          console.log({\n            resp: response,\n            message: \"Respuesta del metodo actualizarUsuario desde onSubmit\"\n          });\n          if (response != null) {\n            debugger;\n            // Hacer el mapeo del \"usuario\" (response.user) y la \"persona\" (response.persona)\n            const {\n              user,\n              persona\n            } = response;\n            _this.usuario_persona_actualizacion = new UsuarioPersona('', new Persona('', '', '', '', '', ''), '', '', '', 'ROLE_USER', '');\n            _this.usuario_persona_actualizacion.persona = persona;\n            _this.usuario_persona_actualizacion._id = user._id;\n            _this.usuario_persona_actualizacion.correo_electronico = user.correo_electronico;\n            _this.usuario_persona_actualizacion.nombre_usuario = user.nombre_usuario;\n            _this.usuario_persona_actualizacion.password = user.password;\n            _this.usuario_persona_actualizacion.rol = user.rol;\n            _this.usuario_persona_actualizacion.imagen = user.imagen;\n            debugger;\n            // Actualizamos el \"identity\" del \"LocalStorage\"\n            localStorage.setItem('identity', JSON.stringify(_this.usuario_persona_actualizacion));\n            // ***** Actualizamos mediante DOM, la variable del nombre de usuario y la imagen. *****\n            // Ya que el \"nombre_usuario\" mostrado por pantalla no se actualiza sino al guardar. Muestra el viejo sino.\n            const element = document.getElementById(\"identity_nombre_usuario\");\n            if (element !== null) {\n              // Si el elemento existe, asignar el valor a innerHTML\n              element.innerHTML = _this.usuario_persona_actualizacion.nombre_usuario;\n            }\n            // Subida de arhivos de imagen (si es que existen)\n            if (!_this.filesToUpload) {\n              // Redireccion\n            } else {\n              debugger;\n              _this.makeFileRequest(_this.url + 'actualizar-imagen-usuario/' + _this.usuario_persona_actualizacion._id, [], _this.filesToUpload).then(result => {\n                debugger;\n                _this.usuario_persona_actualizacion.imagen = result.imagen;\n                debugger;\n                // Actualizar imagen de usuario en app, porque no reflejaba al actualizar sino.\n                let imagen_path = _this.url + 'obtener-archivo-imagen/' + _this.usuario_persona_actualizacion.imagen;\n                document.getElementById(\"imagen-logueado\")?.setAttribute('src', imagen_path);\n              });\n            }\n            // Actualizamos la variable que llena el modelo en html, para reflejar los cambios                \n            _this.identity = JSON.parse(_this._usuarioServicio.getIdentity()); // Convertir la cadena JSON en un objeto JavaScript  \n            //this.identity = this._usuarioServicio.getIdentity();\n            // Actualizamos la variable que usamos para el html de actualizacion (asi refleja en los input)\n            _this.usuario_persona_actualizacion = _this.identity; // JSON.parse(this.identity);\n            // Actualizamos el \"identity\" del \"LocalStorage\"\n            localStorage.setItem('identity', JSON.stringify(_this.usuario_persona_actualizacion));\n            // Mostramos msj de éxito en la actualización\n            _this.alertaActualizacion = 'Usuario actualizado correctamente!!';\n          } else {\n            _this.alertaActualizacion = 'Ocurrió un error en la respuesta al actualizar el usuario';\n          }\n        } catch (error) {\n          _this.alertaActualizacion = error;\n          console.error('Ocurrió un error el OnSubmit:', error);\n        }\n      })();\n    }\n    fileChangeEvent(fileInput) {\n      var _this2 = this;\n      return _asyncToGenerator(function* () {\n        debugger;\n        _this2.filesToUpload = fileInput.target.files; // Recoger archivos seleccionados en el input        \n      })();\n    }\n    // Peticion AJAX para ficheros convencionales. (LLEVARLO A UN SERVICIO). -> Sube el fichero con esto!\n    makeFileRequest(url, params, files) {\n      var _this3 = this;\n      return _asyncToGenerator(function* () {\n        var token = _this3.token;\n        return new Promise(function (resolve, reject) {\n          var formData = new FormData(); // Simular comportamiento de un Form convencional\n          var xhr = new XMLHttpRequest();\n          // Recorremos los ficheros\n          for (var i = 0; i < files.length; i++) {\n            formData.append('imagen', files[i], files[i].name);\n          }\n          // Vemos si está lista la petición para realizarse\n          xhr.onreadystatechange = function () {\n            if (xhr.readyState == 4) {\n              if (xhr.status == 200) {\n                resolve(JSON.parse(xhr.response));\n              } else {\n                reject(xhr.response);\n              }\n            }\n          };\n          xhr.open('POST', url, true);\n          xhr.setRequestHeader('Authorization', token); // VER ESE NOMBRE DE \"AUTHORIZATION\". Creo q es \"authorization\"\n          xhr.send(formData);\n        });\n      })();\n    }\n  }\n  UsuarioEdicionComponent.ɵfac = function UsuarioEdicionComponent_Factory(t) {\n    return new (t || UsuarioEdicionComponent)(i0.ɵɵdirectiveInject(i1.UsuarioServices), i0.ɵɵdirectiveInject(i2.PersonaServices));\n  };\n  UsuarioEdicionComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: UsuarioEdicionComponent,\n    selectors: [[\"usuario-edicion\"]],\n    features: [i0.ɵɵProvidersFeature([UsuarioServices])],\n    decls: 58,\n    vars: 17,\n    consts: [[1, \"col-lg-6\", 2, \"margin\", \"15px\"], [4, \"ngIf\"], [1, \"col-md-7\", 3, \"ngSubmit\"], [\"usuarioActualizacionForm\", \"ngForm\"], [\"type\", \"text\", \"name\", \"nombre\", \"required\", \"\", 1, \"form-control\", 3, \"ngModel\", \"ngModelChange\"], [\"nombre\", \"ngModel\"], [\"type\", \"text\", \"name\", \"apellido\", \"required\", \"\", 1, \"form-control\", 3, \"ngModel\", \"ngModelChange\"], [\"apellido\", \"ngModel\"], [\"type\", \"text\", \"name\", \"direccion\", \"required\", \"\", 1, \"form-control\", 3, \"ngModel\", \"ngModelChange\"], [\"direccion\", \"ngModel\"], [\"type\", \"text\", \"name\", \"telefono\", \"required\", \"\", 1, \"form-control\", 3, \"ngModel\", \"ngModelChange\"], [\"telefono\", \"ngModel\"], [\"type\", \"text\", \"name\", \"nombreUsuario\", \"required\", \"\", 1, \"form-control\", 3, \"ngModel\", \"ngModelChange\"], [\"nombreUsuario\", \"ngModel\"], [\"type\", \"text\", \"name\", \"correoElectronico\", \"required\", \"\", 1, \"form-control\", 3, \"ngModel\", \"ngModelChange\"], [\"correoElectronico\", \"ngModel\"], [\"type\", \"text\", \"name\", \"rol\", \"required\", \"\", 1, \"form-control\", 3, \"ngModel\", \"ngModelChange\"], [\"rol\", \"ngModel\"], [\"class\", \"imagen_para_edicion\", 4, \"ngIf\"], [\"type\", \"file\", \"placeholder\", \"Subir imagen...\", 3, \"change\"], [\"type\", \"submit\", \"value\", \"Actualizar mis datos\", \"required\", \"\", 1, \"btn\", \"btn-primary\"], [\"role\", \"alert\", 1, \"alert\", \"alert-info\"], [1, \"imagen_para_edicion\"], [\"id\", \"imagen-logueado\", 2, \"width\", \"50px\", 3, \"src\"]],\n    template: function UsuarioEdicionComponent_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵelement(0, \"hr\");\n        i0.ɵɵelementStart(1, \"div\", 0)(2, \"h1\");\n        i0.ɵɵtext(3);\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(4, UsuarioEdicionComponent_div_4_Template, 3, 1, \"div\", 1);\n        i0.ɵɵelementStart(5, \"form\", 2, 3);\n        i0.ɵɵlistener(\"ngSubmit\", function UsuarioEdicionComponent_Template_form_ngSubmit_5_listener() {\n          return ctx.onSubmit();\n        });\n        i0.ɵɵelementStart(7, \"p\")(8, \"label\");\n        i0.ɵɵtext(9, \"Nombre/s:\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(10, \"input\", 4, 5);\n        i0.ɵɵlistener(\"ngModelChange\", function UsuarioEdicionComponent_Template_input_ngModelChange_10_listener($event) {\n          return ctx.usuario_persona_actualizacion.persona.nombre = $event;\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(12, UsuarioEdicionComponent_span_12_Template, 2, 0, \"span\", 1);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(13, \"p\")(14, \"label\");\n        i0.ɵɵtext(15, \"Apellido:\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(16, \"input\", 6, 7);\n        i0.ɵɵlistener(\"ngModelChange\", function UsuarioEdicionComponent_Template_input_ngModelChange_16_listener($event) {\n          return ctx.usuario_persona_actualizacion.persona.apellido = $event;\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(18, UsuarioEdicionComponent_span_18_Template, 2, 0, \"span\", 1);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(19, \"p\")(20, \"label\");\n        i0.ɵɵtext(21, \"Direcci\\u00F3n:\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(22, \"input\", 8, 9);\n        i0.ɵɵlistener(\"ngModelChange\", function UsuarioEdicionComponent_Template_input_ngModelChange_22_listener($event) {\n          return ctx.usuario_persona_actualizacion.persona.direccion = $event;\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(24, UsuarioEdicionComponent_span_24_Template, 2, 0, \"span\", 1);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(25, \"p\")(26, \"label\");\n        i0.ɵɵtext(27, \"Tel\\u00E9fono:\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(28, \"input\", 10, 11);\n        i0.ɵɵlistener(\"ngModelChange\", function UsuarioEdicionComponent_Template_input_ngModelChange_28_listener($event) {\n          return ctx.usuario_persona_actualizacion.persona.telefono = $event;\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(30, UsuarioEdicionComponent_span_30_Template, 2, 0, \"span\", 1);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelement(31, \"br\");\n        i0.ɵɵelementStart(32, \"p\")(33, \"label\");\n        i0.ɵɵtext(34, \"Nombre Usuario:\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(35, \"input\", 12, 13);\n        i0.ɵɵlistener(\"ngModelChange\", function UsuarioEdicionComponent_Template_input_ngModelChange_35_listener($event) {\n          return ctx.usuario_persona_actualizacion.nombre_usuario = $event;\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(37, UsuarioEdicionComponent_span_37_Template, 2, 0, \"span\", 1);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(38, \"p\")(39, \"label\");\n        i0.ɵɵtext(40, \"Email:\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(41, \"input\", 14, 15);\n        i0.ɵɵlistener(\"ngModelChange\", function UsuarioEdicionComponent_Template_input_ngModelChange_41_listener($event) {\n          return ctx.usuario_persona_actualizacion.correo_electronico = $event;\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(43, UsuarioEdicionComponent_span_43_Template, 2, 0, \"span\", 1);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(44, \"p\")(45, \"label\");\n        i0.ɵɵtext(46, \"Rol:\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(47, \"input\", 16, 17);\n        i0.ɵɵlistener(\"ngModelChange\", function UsuarioEdicionComponent_Template_input_ngModelChange_47_listener($event) {\n          return ctx.usuario_persona_actualizacion.rol = $event;\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(49, UsuarioEdicionComponent_span_49_Template, 2, 0, \"span\", 1);\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(50, UsuarioEdicionComponent_div_50_Template, 2, 1, \"div\", 18);\n        i0.ɵɵelementStart(51, \"p\")(52, \"label\");\n        i0.ɵɵtext(53, \"Sube tu foto: \");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelement(54, \"br\");\n        i0.ɵɵelementStart(55, \"input\", 19);\n        i0.ɵɵlistener(\"change\", function UsuarioEdicionComponent_Template_input_change_55_listener($event) {\n          return ctx.fileChangeEvent($event);\n        });\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelement(56, \"hr\")(57, \"input\", 20);\n        i0.ɵɵelementEnd()();\n      }\n      if (rf & 2) {\n        const _r2 = i0.ɵɵreference(11);\n        const _r4 = i0.ɵɵreference(17);\n        const _r6 = i0.ɵɵreference(23);\n        const _r8 = i0.ɵɵreference(29);\n        const _r10 = i0.ɵɵreference(36);\n        const _r12 = i0.ɵɵreference(42);\n        const _r14 = i0.ɵɵreference(48);\n        i0.ɵɵadvance(3);\n        i0.ɵɵtextInterpolate(ctx.titulo);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", ctx.alertaActualizacion);\n        i0.ɵɵadvance(6);\n        i0.ɵɵproperty(\"ngModel\", ctx.usuario_persona_actualizacion.persona.nombre);\n        i0.ɵɵadvance(2);\n        i0.ɵɵproperty(\"ngIf\", !_r2.valid && _r2.touched);\n        i0.ɵɵadvance(4);\n        i0.ɵɵproperty(\"ngModel\", ctx.usuario_persona_actualizacion.persona.apellido);\n        i0.ɵɵadvance(2);\n        i0.ɵɵproperty(\"ngIf\", !_r4.valid && _r4.touched);\n        i0.ɵɵadvance(4);\n        i0.ɵɵproperty(\"ngModel\", ctx.usuario_persona_actualizacion.persona.direccion);\n        i0.ɵɵadvance(2);\n        i0.ɵɵproperty(\"ngIf\", !_r6.valid && _r6.touched);\n        i0.ɵɵadvance(4);\n        i0.ɵɵproperty(\"ngModel\", ctx.usuario_persona_actualizacion.persona.telefono);\n        i0.ɵɵadvance(2);\n        i0.ɵɵproperty(\"ngIf\", !_r8.valid && _r8.touched);\n        i0.ɵɵadvance(5);\n        i0.ɵɵproperty(\"ngModel\", ctx.usuario_persona_actualizacion.nombre_usuario);\n        i0.ɵɵadvance(2);\n        i0.ɵɵproperty(\"ngIf\", !_r10.valid && _r10.touched);\n        i0.ɵɵadvance(4);\n        i0.ɵɵproperty(\"ngModel\", ctx.usuario_persona_actualizacion.correo_electronico);\n        i0.ɵɵadvance(2);\n        i0.ɵɵproperty(\"ngIf\", !_r12.valid && _r12.touched);\n        i0.ɵɵadvance(4);\n        i0.ɵɵproperty(\"ngModel\", ctx.usuario_persona_actualizacion.rol);\n        i0.ɵɵadvance(2);\n        i0.ɵɵproperty(\"ngIf\", !_r14.valid && _r14.touched);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", ctx.usuario_persona_actualizacion.imagen && ctx.usuario_persona_actualizacion.imagen != \"null\");\n      }\n    },\n    dependencies: [i3.NgIf, i4.ɵNgNoValidate, i4.DefaultValueAccessor, i4.NgControlStatus, i4.NgControlStatusGroup, i4.RequiredValidator, i4.NgModel, i4.NgForm],\n    encapsulation: 2\n  });\n  return UsuarioEdicionComponent;\n})();\nexport { UsuarioEdicionComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}